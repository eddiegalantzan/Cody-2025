# Customs Data Download Guide

## Overview

This document outlines strategies and sources for downloading customs data (WCO HS Nomenclature and country-specific customs books) from official sources on the internet. This data is required to populate the database tables:
- `wco_editions`, `wco_sections`, `wco_chapters`, `wco_headings`, `wco_hs_codes`
- `customs_books`, `customs_book_hs_codes`

## Data Requirements

### WCO HS Nomenclature (International Standard)
- **WCO Editions**: HS 2022 Edition (current), previous editions as needed
- **Sections**: I through XXI (21 sections)
- **Chapters**: 1 through 97
- **Headings**: 4-digit codes (e.g., 01.01, 01.02)
- **HS Codes**: 6-digit codes (international standard)

### Country-Specific Customs Books
- **EU**: TARIC codes (10 digits)
- **UK**: UK Trade Tariff (10 digits)
- **USA**: HTSUS (10 digits)
- **Israel**: 3 customs books (8-9 digits with check digit)
- **Canada**: Canadian Customs Tariff (10 digits)
- **Mexico**: Mexican Tariff Schedule (10 digits)

---

## Official Data Sources

### 1. WCO (World Customs Organization) - HS Nomenclature

**Source**: [WCO HS Nomenclature 2022 Edition](https://www.wcoomd.org/en/topics/nomenclature/instrument-and-tools/hs-nomenclature-2022-edition/hs-nomenclature-2022-edition.aspx)

**Credentials**: Stored in `.secrets` file:
- `WCO_USERNAME` - WCO account username
- `WCO_PASSWORD` - WCO account password

**Available Data**:
- HS Nomenclature 2022 Edition (current)
- Previous editions (2017, 2012, etc.)
- PDF documents with complete structure (primary format)
- Section notes, chapter notes, heading notes
- Online database via WCO Trade Tools (structured data)

**Download Methods**:
1. **PDF Documents** (Primary Format): Individual PDF files for each chapter/heading
   - **Format**: PDF files organized by chapter and heading
   - **URL Pattern**: `https://www.wcoomd.org/-/media/wco/public/global/pdf/topics/nomenclature/instruments-and-tools/hs-nomenclature-2022/2022/{CHAPTER}{HEADING}_{YEAR}e.pdf`
   - **Example**: `0101_2022e.pdf` for Chapter 1, Heading 01.01
   - **Structure**: Each PDF contains:
     - Heading code (4-digit)
     - Heading description
     - Subheadings (6-digit HS codes)
     - Subheading descriptions
     - Notes and explanatory text
   - **Automated Download Scripts**: ✅ **Available** - See `scripts/README.md` for complete documentation
     - **Browser-based script** (`download-wco-pdfs-browser.ts`) - **Recommended** ✅
       - Usage: `yarn download-wco-pdfs:browser --headless`
       - Status: ✅ 111 PDFs downloaded for 2022 edition
     - **HTTP-based script** (`download-wco-pdfs.ts`)
       - Usage: `yarn download-wco-pdfs`
       - Alternative to browser-based script
     - **Features:** Discovers PDFs, handles authentication, anti-blocking, smart skip logic, configurable additional PDFs
     - **Documentation:** `scripts/README.md` - WCO PDF Download Scripts section
   - **Note**: Requires PDF parsing to extract structured data after download
   - **Challenges**: 
     - PDF parsing is complex and error-prone
     - Text extraction may lose formatting/structure
     - Requires robust parsing logic to handle tables, notes, and hierarchical structure

2. **WCO Trade Tools** (Online Database - Recommended):
   - **URL**: [WCO Trade Tools](https://www.wcoomd.org/en/topics/nomenclature/instrument-and-tools/hs-nomenclature-2022-edition/hs-nomenclature-2022-edition.aspx)
   - **Access**: Free online database platform
   - **Features**: 
     - Latest 5 editions of HS Nomenclature
     - Structured data format (more suitable for integration)
     - Search and query capabilities
     - May support API access or data export
   - **Note**: Check if WCO Trade Tools provides API or bulk export functionality

3. **WCO Data Model**: Standardized framework for electronic data interchange
   - **URL**: [WCO Data Model](https://mag.wcoomd.org/magazine/wco-news-99-issue-3-2022/wco-data-model-guidance-efficient-implementation/)
   - **Purpose**: Structured customs data exchange
   - **Includes**: Information models, codes, harmonized data sets
   - **Note**: May require WCO membership or licensing for full access

4. **WCO Classification Package** (Commercial):
   - Available for purchase through authorized distributors
   - Includes: HS Nomenclature, Explanatory Notes, Alphabetical Index, Compendium of Classification Opinions
   - May include structured data formats (CSV, XML, database dumps)
   - **Note**: Commercial product, verify licensing and pricing

5. **Third-Party Aggregators**: Some commercial services provide structured WCO data
   - Verify data accuracy and licensing before use

**Data Format**: 
- **Primary**: PDF files (one per heading/chapter)
- **Alternative**: WCO Trade Tools online database (structured, may support export)
- **Commercial**: Structured formats from WCO Classification Package

**Implementation Strategy**:
- **Option A** (Recommended): Use WCO Trade Tools online database
  - Check if API or bulk export is available
  - May require web scraping if no API (check terms of service)
  - Structured data is easier to process than PDFs
- **Option B**: Parse PDF documents
  - Use PDF parsing libraries (`pdf-parse` for Node.js, `PyPDF2` for Python)
  - Extract text, tables, and hierarchical structure
  - **Challenges**: Complex parsing logic, error-prone, requires extensive testing
  - **Consider**: Use OCR if PDFs are image-based
- **Option C**: Purchase WCO Classification Package
  - May include structured data formats
  - Verify licensing allows database integration
- **Option D**: Use third-party structured data (verify licensing)

---

### 2. European Union (EU) - TARIC Codes

**Source**: [EU TARIC Database](https://ec.europa.eu/taxation_customs/dds2/taric/taric_consultation.jsp)

**Available Data**:
- Complete TARIC (Integrated Tariff of the European Communities) database
- 10-digit codes (6 WCO + 2 CN + 2 TARIC)
- Updated regularly
- Includes tariff rates, quotas, licenses

**Download Methods**:
1. **EU TARIC Consultation Portal**: Web interface for querying codes
   - URL: `https://ec.europa.eu/taxation_customs/dds2/taric/taric_consultation.jsp`
   - **Note**: Web interface only, no direct bulk download

2. **EU Open Data Portal**: May have structured TARIC data
   - URL: `https://data.europa.eu/`
   - Search for "TARIC" or "customs tariff"

3. **EU Customs Data**: Contact EU customs authorities for bulk data access
   - May require registration or licensing

4. **Third-Party Services**: Commercial services provide EU TARIC data
   - Verify licensing and data accuracy

**Data Format**: Web interface (primary), potentially CSV/XML from EU Open Data Portal

**Implementation Strategy**:
- **Option A**: Web scraping (check terms of service first)
- **Option B**: EU Open Data Portal API (if available)
- **Option C**: Contact EU customs for bulk data access
- **Option D**: Use third-party structured data (verify licensing)

---

### 3. United Kingdom (UK) - UK Trade Tariff

**Source**: [UK Trade Tariff - HMRC](https://www.gov.uk/trade-tariff)

**Available Data**:
- Complete UK Trade Tariff (10 digits)
- Post-Brexit UK-specific classifications
- Updated regularly by HM Revenue & Customs (HMRC)

**Download Methods**:
1. **UK Trade Tariff Website**: Web interface for browsing codes
   - URL: `https://www.gov.uk/trade-tariff`
   - **Note**: Web interface only, no direct bulk download

2. **HMRC API**: Check for official API access
   - Contact HMRC for API documentation
   - May require registration

3. **UK Government Data Portal**: Check data.gov.uk for structured data
   - URL: `https://www.data.gov.uk/`
   - Search for "trade tariff" or "customs"

4. **Third-Party Services**: Commercial services provide UK Trade Tariff data

**Data Format**: Web interface (primary), potentially API or structured data from HMRC

**Implementation Strategy**:
- **Option A**: Contact HMRC for API or bulk data access (recommended)
- **Option B**: Web scraping (check terms of service)
- **Option C**: UK Government Data Portal (if available)
- **Option D**: Use third-party structured data (verify licensing)

---

### 4. United States (USA) - HTSUS

**Source**: [USITC Harmonized Tariff Schedule](https://hts.usitc.gov/)

**Available Data**:
- Complete HTSUS (Harmonized Tariff Schedule of the United States)
- 10-digit codes (6 WCO + 4 USA-specific)
- Maintained by U.S. International Trade Commission (USITC)

**Download Methods**:
1. **USITC DataWeb**: Query and download U.S. trade data
   - URL: `https://dataweb.usitc.gov/`
   - Registration required for API access
   - Supports various classification systems (HTS, SIC, SITC, NAICS)

2. **USITC HTS Website**: Browse HTS codes online
   - URL: `https://hts.usitc.gov/`
   - **Note**: Web interface, may have export options

3. **CBP Public Data Portal**: U.S. Customs and Border Protection data
   - URL: `https://www.cbp.gov/newsroom/stats/cbp-public-data-portal`
   - Free access to statistical data
   - May include tariff information

4. **U.S. Census Bureau Foreign Trade Data**: Import/export statistics
   - URL: `https://www.census.gov/foreign-trade/data/dataproducts.html`
   - Detailed trade data with HS codes

**Data Format**: Web interface, API (with registration), CSV/Excel downloads

**Implementation Strategy**:
- **Option A**: Register for USITC DataWeb API access (recommended)
- **Option B**: Download structured data from USITC website
- **Option C**: Use CBP Public Data Portal for complementary data
- **Option D**: Use third-party structured data (verify licensing)

---

### 5. Israel - Israeli Customs Tariff

**Source**: [Israel Tax Authority - Customs Tariff](https://www.gov.il/en/service/customs-tariff)

**Available Data**:
- Israeli Customs Tariff (8-9 digits with check digit)
- 3 customs books (verify exact structure)
- Maintained by Israel Tax Authority

**Download Methods**:
1. **Israel Tax Authority Website**: Official customs tariff information
   - URL: `https://www.gov.il/en/service/customs-tariff`
   - **Note**: May require Hebrew interface for full access
   - Check for data download options

2. **Israel Government Data Portal**: Check for structured data
   - URL: `https://data.gov.il/` (Hebrew)
   - Search for "מכס" (customs) or "מס ערך מוסף" (VAT)

3. **Direct Contact**: Contact Israel Tax Authority directly
   - Request bulk data access or API documentation
   - May require business registration or licensing

4. **Third-Party Services**: Commercial services may provide Israeli customs data
   - Verify licensing and data accuracy

**Data Format**: Web interface (primary), potentially structured formats from official sources

**Implementation Strategy**:
- **Option A**: Contact Israel Tax Authority directly for bulk data (recommended)
- **Option B**: Check Israel Government Data Portal for structured data
- **Option C**: Web scraping (check terms of service, may require Hebrew interface)
- **Option D**: Use third-party structured data (verify licensing)

**Important Notes**:
- ⚠️ **URGENT**: Verify exact structure of all 3 Israeli customs books
- ⚠️ **URGENT**: Obtain check digit calculation algorithm from Israel Tax Authority
- Some data may only be available in Hebrew

---

### 6. Canada - Canadian Customs Tariff

**Source**: [Canada Border Services Agency (CBSA)](https://www.cbsa-asfc.gc.ca/trade-commerce/tariff-tarif/menu-eng.html)

**Available Data**:
- Canadian Customs Tariff (10 digits)
- Maintained by Canada Border Services Agency (CBSA)

**Download Methods**:
1. **CBSA Trade Tariff Website**: Browse Canadian tariff codes
   - URL: `https://www.cbsa-asfc.gc.ca/trade-commerce/tariff-tarif/menu-eng.html`
   - **Note**: Web interface, check for export/download options

2. **Statistics Canada**: Trade data with HS codes
   - URL: `https://www.statcan.gc.ca/`
   - May have structured trade data

3. **Direct Contact**: Contact CBSA for bulk data access
   - Request structured data or API documentation

4. **Third-Party Services**: Commercial services may provide Canadian customs data

**Data Format**: Web interface (primary), potentially structured formats from official sources

**Implementation Strategy**:
- **Option A**: Contact CBSA for bulk data access (recommended)
- **Option B**: Check Statistics Canada for structured trade data
- **Option C**: Web scraping (check terms of service)
- **Option D**: Use third-party structured data (verify licensing)

---

### 7. Mexico - Mexican Tariff Schedule

**Source**: [Servicio de Administración Tributaria (SAT)](https://www.sat.gob.mx/)

**Available Data**:
- Mexican Tariff Schedule (10 digits, updated 2020)
- Maintained by Servicio de Administración Tributaria (SAT)

**Download Methods**:
1. **SAT Website**: Official Mexican customs tariff information
   - URL: `https://www.sat.gob.mx/`
   - **Note**: Spanish interface, check for data download options

2. **Direct Contact**: Contact SAT for bulk data access
   - Request structured data or API documentation
   - May require business registration

3. **Third-Party Services**: Commercial services may provide Mexican customs data
   - Verify licensing and data accuracy

**Data Format**: Web interface (primary), potentially structured formats from official sources

**Implementation Strategy**:
- **Option A**: Contact SAT for bulk data access (recommended)
- **Option B**: Web scraping (check terms of service, Spanish interface)
- **Option C**: Use third-party structured data (verify licensing)

---

## Alternative Data Sources

### World Trade Organization (WTO) Tariff & Trade Data Platform

**Source**: [WTO Tariff & Trade Data Platform](https://ttd.wto.org/)

**Available Data**:
- Comprehensive tariff and trade data for 150+ economies
- Applied tariffs, import statistics, bound duties
- Annual data from 1996 onwards

**Download Methods**:
- Web interface for querying and downloading data
- May require authorization for certain datasets
- Supports various classification systems

**Use Case**: Complementary data source for verification and cross-referencing

---

### Commercial Data Providers

**Examples**:
- **ImportGenius**: Detailed import/export data from multiple countries
- **Customs Info Database**: Global tariff look-up tool (160+ markets)
- **Trade Data Providers**: Various commercial services

**Considerations**:
- Verify data accuracy and licensing
- Check pricing and subscription models
- Ensure compliance with terms of use
- May provide structured data formats (CSV, JSON, API)

**Use Case**: Alternative source if official data is difficult to obtain or requires significant processing

---

## Implementation Strategy

### Phase 1: Data Source Research & Access

1. **Contact Official Sources**:
   - Reach out to each country's customs authority
   - Request bulk data access, API documentation, or structured data formats
   - Verify licensing requirements and data usage terms

2. **Evaluate Data Formats**:
   - Prefer structured formats (CSV, JSON, XML, database dumps)
   - Assess PDF parsing requirements if structured data unavailable
   - Consider API access for real-time updates

3. **Verify Data Accuracy**:
   - Cross-reference multiple sources when possible
   - Test with known HS codes
   - Validate data structure matches database schema

### Phase 2: Data Download & Processing

1. **Automated Download Scripts**:
   - Create scripts to download data from official sources
   - Handle authentication, rate limiting, and error handling
   - Schedule regular updates (customs data changes periodically)

2. **Data Parsing & Transformation**:
   - Parse structured data (CSV, JSON, XML) into database format
   - Handle PDF parsing if necessary (complex, use libraries like `pdf-parse` for Node.js)
   - Transform data to match database schema structure

3. **Data Validation**:
   - Validate HS code formats (length, check digits)
   - Verify hierarchical relationships (sections → chapters → headings → codes)
   - Check for missing or duplicate data

### Phase 3: Database Import

1. **Import Scripts**:
   - Create TypeScript/Node.js scripts to import data into PostgreSQL
   - Use database connection utilities (from Phase 3)
   - Handle foreign key relationships correctly

2. **Import Order**:
   - Import WCO data first (base structure):
     1. `wco_editions`
     2. `wco_sections`
     3. `wco_chapters`
     4. `wco_headings`
     5. `wco_hs_codes`
   - Then import country-specific data:
     1. `customs_books`
     2. `customs_book_hs_codes` (link to WCO codes)

3. **Error Handling**:
   - Log import errors and missing relationships
   - Handle duplicate data gracefully
   - Validate check digits for countries that use them (e.g., Israel)

### Phase 4: Data Updates & Maintenance

1. **Update Schedule**:
   - Customs data changes periodically (annually or as regulations change)
   - Schedule regular data updates (monthly or quarterly checks)
   - Monitor official sources for data changes

2. **Versioning**:
   - Track customs book versions in `customs_books` table
   - Maintain historical data for reference
   - Handle version transitions gracefully

3. **Data Quality Monitoring**:
   - Monitor for missing or outdated data
   - Validate data integrity regularly
   - Track data source changes

---

## Automated Data Synchronization Mechanisms (Mehavizim)

**Goal:** Automated systems to populate and keep customs book data up-to-date with the most current information from official sources.

### System Architecture

1. **Data Source Monitoring**:
   - Monitor official sources (WCO, country customs authorities) for new versions
   - Check publication dates, version numbers, checksums
   - Track last successful update per data source
   - Detect changes via API polling, web scraping, or RSS feeds (if available)

2. **Automated Download System**:
   - **Download Scripts**: TypeScript/Node.js scripts for each data source
   - **Authentication**: Handle API keys, credentials, session management
   - **Rate Limiting**: Respect API rate limits and implement delays
   - **Error Handling**: Retry logic with exponential backoff
   - **Progress Tracking**: Log download progress and status

3. **Data Change Detection**:
   - Compare new data with existing database records
   - Detect new versions, updated HS codes, deleted codes
   - Calculate checksums/hashes for data integrity verification
   - Track version numbers and publication dates

4. **Automated Import Pipeline**:
   - **Data Parsing**: Parse CSV, JSON, XML, PDF formats
   - **LLM-Based PDF/Text Extraction** (see [5.0_PLAN.md](./5.0_PLAN.md) Phase 3.1 for details): Extract text from PDFs → LLM parses and extracts structured data (HS codes, descriptions, rules, hierarchical structure, check digit algorithms) → Transform to database schema → Validate → Import
   - **Data Transformation**: Convert to database schema format
   - **Validation**: Validate HS code formats, check digits, relationships
   - **Import Order**: Import WCO data first, then country-specific data
   - **Transaction Management**: Use database transactions for atomicity
   - **Error Recovery**: Handle partial failures gracefully

5. **Version Management**:
   - Automatically create new `customs_books` version when update detected
   - Mark previous version as inactive (`customs_book_is_active = false`)
   - Maintain historical data for reference
   - Support rollback to previous version if needed

6. **Scheduled Update Jobs**:
   - **Cron Jobs**: Schedule regular checks (monthly/quarterly)
   - **Job Queue**: Use `job_queue` table for async processing
   - **Scheduling**: Different schedules per country/data source
   - **Notifications**: Alert on successful updates or failures

7. **Incremental Updates**:
   - Support partial updates (only changed HS codes)
   - Compare new data with existing to identify changes
   - Update only modified records for efficiency
   - Track which records were updated

8. **Rules Extraction (LLM-Based)**:
   - Use LLM to parse classification rules from PDFs/text, extract country-specific rules/criteria/exceptions, transform to structured JSON, store in `customs_book_hs_code_country_rules` JSONB field
   - Support manual entry for complex cases, track LLM usage/costs

9. **Data Freshness Tracking**:
   - Track `last_update_time` per customs book
   - Track `last_successful_sync` per data source
   - Monitor data age and alert if updates are overdue
   - Display data freshness in admin dashboard

10. **Multi-Source Support**:
    - Support different data sources per country:
      - WCO (international standard)
      - EU TARIC
      - UK Trade Tariff
      - US HTSUS
      - Israel customs (3 books)
      - Canada, Mexico, etc.
    - Handle different data formats per source
    - Unified import interface for all sources

11. **Error Handling & Retry Logic**:
    - Network failure handling
    - Rate limiting compliance
    - Data source unavailability
    - Invalid data format handling
    - Retry with exponential backoff
    - Alert on persistent failures

12. **Rollback Mechanism**:
    - Backup current customs book version before update
    - Ability to revert to previous version if import fails
    - Validate imported data before marking as active
    - Support manual rollback via admin interface

### Implementation Components

**Required Scripts/Modules:**
- `scripts/download-wco-pdfs.ts` - ✅ **WCO PDF download script** (TypeScript, ready to use)
- `src/data-sync/downloaders/` - Data source download scripts (for other sources: EU TARIC, UK Trade Tariff, US HTSUS, Israel customs, etc.)
- `src/data-sync/parsers/` - Data format parsers (CSV, JSON, XML, PDF) + LLM-based PDF extraction
- `src/data-sync/importers/` - Database import scripts
- `src/data-sync/validators/` - Data validation utilities
- `src/data-sync/schedulers/` - Scheduled job management
- `src/data-sync/monitors/` - Data source change detection

**Database Tables:**
- `customs_books` - Store customs book metadata, versions, sync tracking fields (see `init.sql`)
- `customs_book_hs_codes` - Store HS codes with rules
- `job_queue` - Queue scheduled sync jobs
- `audit_logs` - Log sync operations and results

**Configuration:**
- Data source URLs and credentials
- Update schedules per source
- Validation rules per country
- Check digit algorithms per country

### Update Frequency Recommendations

- **WCO HS Nomenclature**: Annual (new editions every 5 years, but check for updates)
- **EU TARIC**: Monthly (regular updates)
- **UK Trade Tariff**: Monthly (regular updates)
- **US HTSUS**: Monthly (regular updates)
- **Israel Customs**: Monthly (verify update frequency with Israel Tax Authority)
- **Other Countries**: Quarterly (verify per country)

### Success Criteria

- ✅ Automated detection of new customs book versions
- ✅ Automated download and import of updated data
- ✅ Data freshness tracking and monitoring
- ✅ Error handling and recovery
- ✅ Version management and rollback capability
- ✅ Support for all required data sources
- ✅ Rules extraction and storage in database
- ✅ Scheduled updates running automatically

---

## Recommended Tools & Libraries

### Data Download
- **Node.js**: `axios`, `node-fetch` for HTTP requests
- **Python**: `requests`, `beautifulsoup4` for web scraping (if needed)
- **Rate Limiting**: `bottleneck`, `p-limit` for controlled API access

### Data Parsing
- **CSV**: `csv-parse` (Node.js), `pandas` (Python)
- **JSON**: Native JSON parsing
- **XML**: `xml2js` (Node.js), `xml.etree.ElementTree` (Python)
  - **PDF** (WCO Primary Format): 
  - **PDF to Markdown Conversion (Step 1 - Recommended):** ✅ **Available** - See `scripts/pdf-to-markdown.ts`
    - Converts PDFs to Markdown format for better LLM processing
    - **Tools available:**
      - `marker` (Python) - **Recommended** - AI-powered, best structure preservation (tables, formatting, hierarchy)
      - `pdfplumber` (Python) - Good structure preservation, no GPU needed
      - `pdfjs-dist` (Node.js) - Pure TypeScript, basic conversion
    - **Usage:** `yarn pdf-to-markdown --tool marker`
    - **Output:** Markdown files saved to `./data/wco-pdfs/{edition}/markdown/`
    - See `scripts/pdf-to-markdown-setup.md` and `scripts/README.md` for full documentation
  - **Text Extraction (Alternative Step 1):**
    - **Node.js**: 
      - `pdf-parse` - Basic text extraction
      - `pdfjs-dist` - Mozilla's PDF.js (more advanced, supports tables)
      - `pdf2json` - Extract text and structure
      - `pdf-table-extractor` - Extract tables from PDFs
    - **Python**: 
      - `PyPDF2` / `pypdf` - Basic PDF reading
      - `pdfplumber` - Better table extraction
      - `camelot-py` - Table extraction from PDFs
      - `tabula-py` - Extract tables to pandas DataFrames
  - **LLM-Based Structured Extraction (Step 2 - Recommended):**
    - Extract text/Markdown from PDFs → Use LLM to parse and extract structured data (HS codes, descriptions, rules, hierarchical structure, check digit algorithms)
    - LLM transforms to database schema format and validates structure
    - **Advantages**: Handles complex PDF structures, extracts rules from unstructured text, understands context
    - **Input**: Markdown files (from Step 1) or raw text extraction
  - **Challenges**: 
    - PDFs may contain tables, notes, and hierarchical structures
    - Text extraction may lose formatting
    - Requires parsing logic for HS code structure
    - May need OCR if PDFs are image-based
  - **Recommendation**: 
    - **Option A (Recommended)**: Use LLM-based extraction after Markdown conversion
      - ✅ Markdown files already created (111 files for 2022 edition)
      - Use LLM to parse and structure the Markdown text
      - More accurate for complex PDFs and unstructured rules
      - Markdown format preserves structure better than plain text
    - **Option B**: First try WCO Trade Tools online database (structured data)
    - **Option C**: Traditional parsing with `pdfplumber` (Python) or `pdfjs-dist` (Node.js) if LLM not available
    - **Option D**: Consider commercial WCO Classification Package if both approaches prove too complex

### Database Import
- **PostgreSQL**: `pg` (Node.js), `psycopg2` (Python)
- **Batch Insert**: Use `COPY` command for large datasets
- **Transaction Management**: Use transactions for data integrity

---

## Action Items

### High Priority
- [ ] **Evaluate WCO Trade Tools**: Check if WCO Trade Tools online database provides API or bulk export (preferred over PDF parsing)
- [ ] **Contact WCO**: Request structured HS Nomenclature data (CSV, JSON, or database dump) - alternative to PDF files
- [x] ✅ **WCO PDF Download** - **COMPLETED** (111 PDFs for 2022 edition)
- [x] ✅ **PDF to Markdown Conversion** - **COMPLETED** (111 Markdown files created)
- [ ] **WCO PDF Parsing** (if structured data unavailable): 
  - [x] ✅ Download all WCO PDF files - **COMPLETED**
  - [x] ✅ Convert PDFs to Markdown format - **COMPLETED**
  - [ ] Test PDF parsing libraries (`pdfplumber`, `pdfjs-dist`)
  - [ ] Develop parsing logic for HS code extraction
  - [ ] Validate parsed data accuracy
- [ ] **Contact Israel Tax Authority**: Request bulk data access for 3 customs books + check digit algorithm
- [ ] **Contact USITC**: Register for DataWeb API access for HTSUS data
- [ ] **Contact EU Customs**: Request TARIC bulk data access or API documentation
- [ ] **Contact HMRC**: Request UK Trade Tariff bulk data access or API documentation
- [ ] **Contact CBSA**: Request Canadian Customs Tariff bulk data access
- [ ] **Contact SAT**: Request Mexican Tariff Schedule bulk data access

### Medium Priority
- [ ] **Evaluate Commercial Providers**: Assess pricing and data quality for alternative sources
- [x] **Create Data Download Scripts**: Automated scripts for downloading from available sources
  - [x] ✅ WCO PDF download script (`scripts/download-wco-pdfs.ts`) - **COMPLETED**
  - [ ] Other data source download scripts (EU TARIC, UK Trade Tariff, US HTSUS, Israel customs, etc.)
- [ ] **Create Data Parsing Scripts**: Transform downloaded data into database format
- [ ] **Create Database Import Scripts**: Import parsed data into PostgreSQL
- [ ] **Implement Automated Data Synchronization Mechanisms (Mehavizim)**:
  - [ ] Build data source monitoring system (detect new versions, changes)
  - [ ] Create automated download system with retry logic
  - [ ] Implement data change detection (compare versions, checksums)
  - [ ] Build automated import pipeline (parse, validate, import)
  - [ ] **LLM-Based PDF/Text Extraction** (see [5.0_PLAN.md](./5.0_PLAN.md) Phase 3.1 for detailed tasks):
    - [ ] PDF text extraction → LLM-based structured extraction (HS codes, rules, hierarchical structure, country-specific codes) → Database transformation/validation → Batch processing with error handling and cost tracking
  - [ ] Create version management system (auto-create new versions)
  - [ ] Implement scheduled update jobs (cron/job queue)
  - [ ] Add incremental update support (partial updates)
  - [ ] Build rules extraction system (LLM-based: parse and store classification rules)
  - [ ] Implement data freshness tracking
  - [ ] Add rollback mechanism for failed imports
  - [ ] Create error handling and retry logic
  - [ ] Build multi-source support (WCO, EU, UK, US, Israel, etc.)

### Low Priority
- [ ] **PDF Parsing Implementation**: Full implementation of WCO PDF parsing if structured data unavailable
  - [x] ✅ Download all WCO PDF files (97 chapters × multiple headings) - **COMPLETED** (see `scripts/download-wco-pdfs.ts`)
  - [ ] Implement robust parsing logic for hierarchical structure
  - [ ] Handle edge cases (notes, exceptions, special formatting)
  - [ ] Create validation tests for parsed data
- [ ] **Web Scraping**: Implement web scraping for WCO Trade Tools as fallback (check terms of service)

---

## Notes & Considerations

1. **Licensing**: Verify data licensing and usage terms for each source
2. **Rate Limiting**: Respect API rate limits and implement appropriate delays
3. **Data Accuracy**: Cross-reference data from multiple sources when possible
4. **Language**: Some sources may only be available in local languages (Hebrew, Spanish)
5. **Updates**: Customs data changes periodically; plan for regular updates
6. **Check Digits**: Implement check digit validation for countries that use them (Israel)
7. **Data Volume**: Customs data can be large (thousands of codes); optimize import performance

---

## References

- [WCO HS Nomenclature 2022 Edition](https://www.wcoomd.org/en/topics/nomenclature/instrument-and-tools/hs-nomenclature-2022-edition/hs-nomenclature-2022-edition.aspx)
- [EU TARIC Database](https://ec.europa.eu/taxation_customs/dds2/taric/taric_consultation.jsp)
- [UK Trade Tariff - HMRC](https://www.gov.uk/trade-tariff)
- [USITC DataWeb](https://dataweb.usitc.gov/)
- [USITC HTS](https://hts.usitc.gov/)
- [CBP Public Data Portal](https://www.cbp.gov/newsroom/stats/cbp-public-data-portal)
- [Israel Tax Authority - Customs Tariff](https://www.gov.il/en/service/customs-tariff)
- [Canada Border Services Agency](https://www.cbsa-asfc.gc.ca/trade-commerce/tariff-tarif/menu-eng.html)
- [WTO Tariff & Trade Data Platform](https://ttd.wto.org/)
- [Customs Info Database](https://www.trade.gov/customs-info-database-user-guide)

---

## Document Version

- **Created**: 2025-01-XX
- **Last Updated**: 2025-01-XX
- **Status**: ⚠️ **WORKING DOCUMENT - Implementation Required**
- **Next Review**: After contacting official data sources

