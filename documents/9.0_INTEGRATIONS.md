# Third-Party Integrations

This document outlines the third-party services integrated into the project, their API capabilities, and implementation guidelines.

**Company Context:** Israeli company serving worldwide customers  
**Business Model:** B2B (Business-to-Business)

---

## User Management: Clerk.com

**Service:** [Clerk.com](https://clerk.com) - Authentication and user management platform

**Purpose:** User authentication, profile/session management, RBAC, MFA, social auth. **B2B:** Organization/team management, multi-tenant support, organization-level roles/permissions, team invitations, billing.

**Integration:**
1. **SDK:** React SDK (frontend), Node.js SDK (backend), middleware for protected routes
2. **Webhooks:** User events (create, update, delete), sync to PostgreSQL, handle deletions
3. **Database:** Store Clerk user ID and organization ID as foreign keys, additional metadata, organization info, maintain referential integrity, organization-level data isolation

**Required Secrets:** `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY`, `CLERK_SECRET_KEY`, `CLERK_WEBHOOK_SECRET`

**Docs:** https://clerk.com/docs | API: https://clerk.com/docs/reference/backend-api | Webhooks: https://clerk.com/docs/integrations/webhooks

---

## Payment Management: Payoneer

**Service:** [Payoneer](https://www.payoneer.com) - Payment gateway and money transfer platform

**Purpose:** Receive payments (B2B), send via bank transfers (mass payouts), real-time status, payment requests/history, webhooks, payee management. **B2B:** Invoice-based payments, payment terms (net 30/60), bulk processing, approval workflows, organization-level accounts. **Note:** Recurring payments not available (U.S. only) - implement custom scheduling.

**API Capabilities:**
- **Receiving:** Mass Payout & Services API, payment methods (cards, ACH U.S., bank transfers EU, PayPal), global collection accounts
- **Sending:** Mass Payout API, bank transfers worldwide (ACH U.S., SEPA EU, BACS UK, BECS AU), payee registration/approval, mass payouts. **Note:** SEPA particularly useful for EU customers
- **Status:** `GET /v4/accounts/{account_id}/payments/{payment_id}`, real-time tracking, statuses: `pending`, `processing`, `completed`, `failed`, `cancelled`
- **Recurring:** Not available for non-U.S. businesses - implement custom scheduling with cron jobs/task schedulers

**API Docs:** https://www.payoneer.com/partners/integrated-payments-api/ | Sandbox available

**Key Endpoints:** `POST /v4/accounts/{account_id}/payments` (request), `GET /v4/accounts/{account_id}/payments/{payment_id}` (status), `GET /v4/accounts/{account_id}/payments` (list), `POST /v4/accounts/{account_id}/payees` (register), `PUT /v4/accounts/{account_id}/payees/{payee_id}/approve` (approve), `POST /v4/accounts/{account_id}/payouts` (transfer)

**Required Secrets:** `PAYONEER_API_KEY`, `PAYONEER_API_SECRET`, `PAYONEER_ACCOUNT_ID`, `PAYONEER_WEBHOOK_SECRET` (if available)

**Implementation:**
1. **Wrapper:** Create `PayoneerWrapper` ([4.0_WRAPPERS_GUIDE.md](./4.0_WRAPPERS_GUIDE.md)), type-safe interfaces, AppError handling
2. **Database:** Store payment requests/statuses/history, scheduled payment configs (frequency, amount, next date, timezone), link to users (Clerk ID), track scheduled status (active/paused/cancelled)
3. **Webhooks:** Payment status updates, verify signatures, update database
4. **Polling Fallback:** Exponential backoff, store last checked timestamp
5. **Custom Recurring:** Cron jobs/task schedulers, store schedules in DB, auto-create requests, retry logic, pause/cancel support, handle timezones/currencies, support regional payment methods
6. **Error Handling:** Rate limits, exponential backoff retries, audit logging

---

## Email Service: Mailgun

**Service:** [Mailgun](https://www.mailgun.com) - Email delivery and receiving platform

**Purpose:** **Sending:** Transactional emails, B2B communications (invoices, confirmations), organization notifications, templates, tracking, bounce handling. **Receiving:** Inbound webhooks, email parsing/routing, **HS code classification via email** (email-to-email service), support tickets, organization-level routing.

**Email-to-Email HS Code Classification Workflow:**
1. User sends email with product description and customs book (optional, defaults if not specified)
2. System parses email, extracts description and customs book preference
3. System processes classification (standard, list lookup, or interactive)
4. System sends result email with HS code(s) for item(s)
5. Supports multiple items per email (one per line or structured format)

**Why Mailgun:** Best for sending & receiving (webhook support, no IMAP polling), international support, developer-friendly (TypeScript API, clear docs, sandbox), cost-effective (5,000 emails/month free for 3 months, ~$0.80/1,000 after), B2B features (organization routing, multi-tenant isolation).

**API Capabilities:**
- **Sending:** `POST /v3/{domain}/messages`, templates (stored/inline), batch/scheduled sending, tracking (opens/clicks/bounces), suppression lists
- **Receiving:** `POST /v3/routes`, email parsing, webhook delivery, route filtering, attachments. **Note:** Requires domain verification and MX records
- **Validation:** Email address/domain validation, disposable email detection

**API Docs:** https://documentation.mailgun.com/ | Sandbox domain available

**Key Endpoints:** `POST /v3/{domain}/messages` (send), `GET /v3/{domain}/events` (list), `GET /v4/address/validate` (validate), `POST /v3/routes` (inbound route)

**Required Secrets:** `MAILGUN_API_KEY`, `MAILGUN_DOMAIN`, `MAILGUN_WEBHOOK_SIGNING_KEY`, `MAILGUN_FROM_EMAIL`, `MAILGUN_FROM_NAME`

**Implementation:**
1. **Wrapper:** Create `MailgunWrapper` ([4.0_WRAPPERS_GUIDE.md](./4.0_WRAPPERS_GUIDE.md)), type-safe interfaces, AppError handling
2. **Database:** Store sent logs (recipient, subject, status, sent_at, opened_at, clicked_at), inbound records (sender, subject, body, received_at, customs_book_preference), link to users/organizations (Clerk IDs), templates, bounce/complaint records, index frequently queried fields
3. **Webhooks:** Inbound emails and delivery events (bounces/opens/clicks), verify signatures, update database, handle idempotency
4. **Email Parsing:** Extract product description and customs book from email body/subject, support structured formats (JSON, CSV) or plain text, handle multiple items per email, default customs book logic (user preference → organization default → system default)
5. **Templates:** Store in DB or use Mailgun's, organization-level branding, multi-language, personalization variables, result email templates with HS code(s)
6. **Error Handling:** Rate limits (10,000 requests/hour), exponential backoff retries, audit logging, handle bounces/complaints
7. **Domain Setup:** Verify domain, configure DNS (SPF/DKIM/DMARC), MX records for inbound, test in staging environment

---

## WhatsApp Service: Official Meta WhatsApp Business API

**Service:** [WhatsApp Business API](https://developers.facebook.com/docs/whatsapp) - Official Meta/Facebook WhatsApp Business API

**Purpose:** **Sending:** Transactional messages (OTP, 2FA), B2B notifications, organization alerts, scheduled/bulk delivery, status tracking, rich media. **Receiving:** Inbound webhooks, two-way conversations, customer support, authentication, organization routing, media handling.

**Why Official Meta API:**
- **Cost-Effective:** No per-message fees (conversation-based pricing), first 1,000 user-initiated conversations/month FREE, utility/auth: ~$0.0085/session (U.S.), marketing: ~$0.0133/session, service: FREE, no middleman fees, better for high volume
- **Direct Integration:** Direct API access, no third-party dependencies, full control, latest features first
- **International:** Global delivery (180+ countries), no local phone numbers needed, strong deliverability, WhatsApp popular in Israel
- **B2B:** Organization routing, multi-tenant number management, templates, delivery tracking per organization
- **Advantages:** Higher engagement than SMS, rich media, read receipts, primary messaging app in many countries

**Pricing (10,000 messages/month, U.S.):**
- ~$85 (utility/auth) or ~$76.50 (if 1,000 user-initiated free), no per-message fees
- First 1,000 user-initiated conversations/month FREE
- Conversation-based pricing (utility/auth: ~$0.0085/session, marketing: ~$0.0133/session, service: FREE)

**API Capabilities:**
- **Sending:** `POST /v18.0/{phone-number-id}/messages`, SDK available, text/media/templates/interactive, scheduled/batch sending, status tracking (sent/delivered/read/failed), webhook receipts, rich media (images/documents/videos/audio)
- **Receiving:** Webhook routing (configure in Meta Business Manager), message parsing, two-way conversations, media attachments. **Note:** Requires WhatsApp Business Account setup
- **Templates:** Pre-approved templates, approval process required, variables/personalization, multi-language. **Note:** After 24-hour window, must use approved templates
- **Business Account:** Direct setup via Meta Business Manager, business verification required (days/weeks), full control, Meta Business Suite access

**API Docs:** https://developers.facebook.com/docs/whatsapp | Cloud API: https://developers.facebook.com/docs/whatsapp/cloud-api | Getting Started: https://developers.facebook.com/docs/whatsapp/cloud-api/get-started

**Key Endpoints:** `POST /v18.0/{phone-number-id}/messages` (send), `GET /v18.0/{message-id}` (status), `POST /v18.0/{phone-number-id}/media` (upload), `GET /v18.0/{media-id}` (get media)

**Required Secrets:** `WHATSAPP_BUSINESS_ACCOUNT_ID`, `WHATSAPP_ACCESS_TOKEN` (long-lived), `WHATSAPP_PHONE_NUMBER_ID`, `WHATSAPP_APP_SECRET`, `WHATSAPP_VERIFY_TOKEN`, `WHATSAPP_WEBHOOK_SECRET` (optional)

**Implementation:**
1. **Wrapper:** Create `WhatsAppBusinessWrapper` ([4.0_WRAPPERS_GUIDE.md](./4.0_WRAPPERS_GUIDE.md)), type-safe interfaces, SDK or REST API, AppError handling, handle templates/media/24-hour window
2. **Database:** Store sent logs (recipient, message, status, sent_at, delivered_at, read_at, failed_at), inbound records (sender, message, media_urls, received_at), link to users/organizations (Clerk IDs), templates, delivery status/errors, media attachments, 24-hour conversation windows, conversation types (utility/auth/marketing/service) for billing, index frequently queried fields, WhatsApp number mappings
3. **Webhooks:** Inbound messages and delivery status (delivered/read/failed), verify signatures, handle verification challenge (GET with verify token), update database, idempotency, two-way conversations, media handling
4. **Account Setup:** Create Meta Business Account/Manager, WhatsApp Business Account, business verification (days/weeks), add phone number, configure webhook URLs
5. **Templates:** Store in DB, organization-level branding, multi-language, variables, pre-approved by Meta/WhatsApp, submit via Business Manager/API, handle 24-hour window
6. **24-Hour Window:** Track last message timestamp per recipient, within 24h: free-form messages, outside 24h: approved templates, check window status before sending, store expiration timestamps, track conversation types for billing
7. **Error Handling:** Rate limits (varies by account/country), exponential backoff retries, audit logging, handle delivery failures, monitor undelivered, template approval rejections, access token expiration (refresh long-lived tokens)
8. **International:** Country-specific phone formats, international dialing codes, timezone considerations, multi-language support, verify availability, check country-specific pricing
9. **Cost Optimization:** Monitor conversation types (service free), track user-initiated (first 1,000/month free), use 24-hour window effectively, monitor costs per organization, rate limiting, cache templates, batch messages
10. **Media:** Support images/documents/videos/audio, upload to Meta's servers first, store URLs, handle uploads, media size limits, support in templates
11. **Business Manager:** Create Facebook App, configure WhatsApp product, webhook subscriptions, generate access tokens (short/long-lived), webhook verification, phone number and business profile

---

## Wrapper Implementation

All services must be wrapped according to [4.0_WRAPPERS_GUIDE.md](./4.0_WRAPPERS_GUIDE.md):

**Required Wrappers:**
- **ClerkWrapper** (`src/wrappers/ClerkWrapper.ts`): Type-safe Clerk SDK, authentication, session management, webhook verification
- **PayoneerWrapper** (`src/wrappers/PayoneerWrapper.ts`): Type-safe Payoneer API, payment requests, bank transfers (ACH/SEPA/BACS/BECS), payee management, status checking, webhooks. **Note:** Recurring payments not available (U.S. only) - use scheduled one-time payments
- **MailgunWrapper** (`src/wrappers/MailgunWrapper.ts`): Type-safe Mailgun API, email sending (transactional/templates/batch), inbound webhooks, validation, signature verification, event tracking (bounces/opens/clicks)
- **WhatsAppBusinessWrapper** (`src/wrappers/WhatsAppBusinessWrapper.ts`): Type-safe WhatsApp API, message sending (transactional/templates/batch/scheduled), inbound webhooks, number management, signature verification, delivery tracking (delivered/read/failed), two-way conversations, 24-hour window management, media handling, conversation type tracking
- **OpenAIWrapper** (`src/wrappers/OpenAIWrapper.ts`): Type-safe OpenAI API client, GPT-4/GPT-3.5 integration, chat completions, token tracking, cost calculation, rate limiting, error handling
- **AnthropicWrapper** (`src/wrappers/AnthropicWrapper.ts`): Type-safe Anthropic API client, Claude 3 integration, message completions, token tracking, cost calculation, rate limiting, error handling
- **GoogleGeminiWrapper** (`src/wrappers/GoogleGeminiWrapper.ts`): Type-safe Google Gemini API client, Gemini Pro/Ultra integration, chat completions, token tracking, cost calculation, rate limiting, error handling
- **XAIWrapper** (`src/wrappers/XAIWrapper.ts`): Type-safe xAI Grok API client, Grok-1/Grok-2 integration, chat completions, token tracking, cost calculation, rate limiting, error handling

**Wrapper Requirements:** Type-safe interfaces (no `any`), consistent AppError handling, context-prefixed logging, abstract implementation details, JSDoc comments, support sync/async operations

---

## Security Considerations

**API Key Management:** Store in secrets management ([7.0_SECRETS_MANAGEMENT.md](./7.0_SECRETS_MANAGEMENT.md)), never expose in client-side code, use environment-specific keys (local/staging), rotate regularly

**Note:** Production environment not needed until client is secured. Currently supporting local and staging environments only.

**Webhook Security:** Validate signatures for all incoming webhooks, use HTTPS, implement idempotency checks, rate limit endpoints

**API Communication:** Use HTTPS, implement rate limiting, exponential backoff for retries, monitor usage and costs

**Data Protection:** Encrypt sensitive payment data at rest, never log full payment details or API keys, follow PCI DSS guidelines, implement audit logging for payment operations

---

## Database Schema Considerations

**User-Payment Relationship:** Link payments to users (Clerk user ID) and organizations (Clerk organization ID), store payment metadata, maintain referential integrity, index frequently queried fields (user_id, organization_id, payment_status, created_at), store customer location/region, track currency and timezone

**B2B Schema:** Organization/company table, organization payment accounts, payment terms per organization, invoice tracking, organization-level payment history, team member payment permissions

**Payment Status Tracking:** Store payment status history, track status change timestamps, store webhook event logs for debugging

---

## Testing

**Integration Testing:** Test with sandbox/test credentials, mock API responses for unit tests, test webhook handlers with sample payloads, test error scenarios (rate limits, network failures)

**Test Accounts:** Clerk: test mode for development | Payoneer: sandbox environment | Mailgun: sandbox domain | WhatsApp: Meta Business Manager test environment | LLM Providers: API keys with test/development quotas

---

## LLM Providers: OpenAI, Anthropic, Google Gemini, xAI Grok

**Service:** Multiple LLM providers for HS code classification and related AI tasks

**Purpose:** 
- HS code classification using customs book rules as context
- Question generation for interactive classification sessions
- Abstract description detection and rejection
- Product description analysis and validation
- Classification confidence scoring

**Supported Providers:**
- **OpenAI**: GPT-4, GPT-3.5-turbo, GPT-4-turbo
- **Anthropic**: Claude 3 Opus, Claude 3 Sonnet, Claude 3 Haiku
- **Google**: Gemini Pro, Gemini Ultra
- **xAI (Grok)**: Grok-1, Grok-2

**Integration Requirements:**

1. **LLM Provider Abstraction Layer:** Unified interface for all providers, provider-agnostic API design, easy to add new providers, consistent error handling

2. **Provider-Specific Integrations:** OpenAI, Anthropic, Google Gemini, xAI (Grok) - Official SDKs, API key authentication, rate limiting

3. **LLM Task Implementations:**
   - **HS Code Classification**: Use LLM with customs book rules context from database
   - **Question Generation**: Generate clarifying questions when HS code is unknown
   - **Abstract Description Detection**: Detect and reject vague descriptions (e.g., "gift")
   - **Product Description Analysis**: Validate and enhance product descriptions
   - **Confidence Scoring**: LLM provides confidence scores for classifications
   - **Customs Book Data Extraction from PDFs/Text**: Extract structured data (HS codes, descriptions, rules) from customs book PDFs/text, parse hierarchical structure, extract rules and country-specific codes, transform to database schema format

4. **LLM Usage Tracking:**
   - Track tokens (input, output, total), costs, response times per classification
   - Store in `classifications` table: `llm_provider`, `llm_model`, `llm_input_tokens`, `llm_output_tokens`, `llm_total_tokens`, `llm_cost`, `llm_response_time_ms`

5. **LLM Configuration:** Model selection per task, provider selection logic (cost/performance/availability), prompt engineering, context size management

6. **LLM Error Handling:** Retry logic with exponential backoff, fallback providers, rate limit handling, timeout management

7. **LLM Cost Optimization:** Response caching, context optimization, model selection based on cost/performance trade-offs

**Required Secrets:**
- `OPENAI_API_KEY`
- `ANTHROPIC_API_KEY`
- `GOOGLE_GEMINI_API_KEY`
- `XAI_API_KEY` (for Grok)

**Database Schema:**
- LLM usage tracking fields in `classifications` table: `llm_provider`, `llm_model`, `llm_input_tokens`, `llm_output_tokens`, `llm_total_tokens`, `llm_cost`, `llm_response_time_ms`

**Implementation:**
- Create LLM provider wrappers (see [4.0_WRAPPERS_GUIDE.md](./4.0_WRAPPERS_GUIDE.md))
- Implement provider abstraction layer
- Integrate with HS code classifier engine (Phase 3.1)
- Track usage and costs for billing

**Docs:**
- OpenAI: https://platform.openai.com/docs
- Anthropic: https://docs.anthropic.com
- Google Gemini: https://ai.google.dev/docs
- xAI (Grok): https://docs.x.ai (or official xAI API documentation)

---

## International Considerations

**Multi-Region Support (Israeli company serving worldwide):**

- **Payment Methods:** EU/EEA: SEPA (recommended), US: ACH Debit, UK: BACS, Australia: BECS, Other: Verify with Payoneer
- **Currency:** Support multiple currencies, store preferences per customer, handle conversion if needed, display in customer's preferred currency
- **Timezone:** Store customer timezone preferences, schedule payments based on timezone, display timestamps in local time, handle DST transitions
- **Compliance:** GDPR (EU customers), regional data protection laws, payment regulations by region, tax compliance, B2B contract compliance, organization-level data protection agreements
- **B2B:** Organization/company management, multi-tenant data isolation, team member roles/permissions, organization-level billing/subscriptions, invoice management, payment terms/approval workflows, business account management

---

## Related Documentation

- [4.0_WRAPPERS_GUIDE.md](./4.0_WRAPPERS_GUIDE.md) - Wrapper implementation guidelines
- [7.0_SECRETS_MANAGEMENT.md](./7.0_SECRETS_MANAGEMENT.md) - Secrets configuration
- [8.0_SECURITY.md](./8.0_SECURITY.md) - Security practices
- [5.0_PLAN.md](./5.0_PLAN.md) - Project plan with integration phases
- [6.0_STEP_1_TERRAFORM_POSTGRES.md](./6.0_STEP_1_TERRAFORM_POSTGRES.md) - Infrastructure setup
- [11.0_CUSTOMS_DATA_DOWNLOAD.md](./11.0_CUSTOMS_DATA_DOWNLOAD.md) - Customs data download guide and automated synchronization mechanisms

