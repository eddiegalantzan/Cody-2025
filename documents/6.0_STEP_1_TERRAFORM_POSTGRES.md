# Step 1: Terraform Full-Stack Infrastructure Setup

## Overview
This step provisions a **full-stack application server** on a cloud provider with:
- **PostgreSQL database** (self-managed)
- **Backend application** (Node.js/TypeScript ready)
- **Frontend application** (React ready)

All services run on a **single droplet** for cost-effective staging deployment.

## Prerequisites
- Terraform â‰¥ 1.7
- Cloud provider account and credentials
- **ðŸ“– DigitalOcean Setup:** See [6.1_DIGITALOCEAN_SETUP.md](./6.1_DIGITALOCEAN_SETUP.md) for detailed step-by-step instructions

## Cloud Providers (Cost-Effective)
- **Hetzner** - $4-6/month (best price, EU-based, good for worldwide)
- **Vultr** - $6-10/month (multiple regions including EU)
- **DigitalOcean** - $12-24/month (easiest, multiple regions, recommended for full-stack)
- **Linode** - $12-24/month (multiple regions)

**Recommendation:** 
- **DigitalOcean** for ease of use and multiple regions (currently configured)
- **Hetzner** for cost (EU-based, good latency for EU/ME customers) - requires provider change
- Consider region selection based on customer base (EU regions for Israeli company serving worldwide)

## Structure
```
infra/terraform/
â”œâ”€â”€ main.tf
â”œâ”€â”€ variables.tf
â”œâ”€â”€ outputs.tf
â”œâ”€â”€ versions.tf
â””â”€â”€ terraform.tfvars.example
```

## Configuration
All values should be defined in `src/shared/single-source.ts` when created (see [1.0_PRINCIPLES.md](./1.0_PRINCIPLES.md)). Example structure:
```typescript
export const CONFIG = {
  DATABASE: {
    VERSION: '16',
    SIZE: 's-1vcpu-1gb', // Start small, upgrade if needed
    REGION: 'fra1', // Example: Frankfurt (EU) - adjust based on customer base
    // Alternative regions: 'ams3' (Amsterdam), 'lon1' (London), 'nyc3' (New York)
    STORAGE_SIZE_GB: 25,
    BACKUP_ENABLED: true,
  },
  APP: {
    PORT: 3000,
    NODE_VERSION: '22',
  },
} as const;
```

**Region Selection for Israeli Company:**
- **EU regions** (Frankfurt, Amsterdam, London) - Good for EU customers and Israeli company
- **US regions** - For US customer base
- Consider multi-region setup for worldwide customers if needed

## Files

**versions.tf** - Terraform/provider versions  
**variables.tf** - Input variables (reference `src/shared/single-source.ts` when created)  
**main.tf** - Provider + full-stack server (database + app) + security  
**outputs.tf** - Connection details (mark sensitive)  
**user_data.sh** - Server initialization script (installs PostgreSQL, Node.js, etc.)

## Steps
1. `terraform init`
2. Create files (reference `src/shared/single-source.ts` when created)
3. `terraform validate`
4. `terraform plan`
5. `terraform apply`

## Outputs
- `server_ip` - Application server IP address
- `database_host`, `database_port`, `database_name`
- `database_user`, `database_password` (sensitive)
- `database_url` - Remote database connection (sensitive)
- `database_url_local` - Localhost database connection for app (sensitive)
- `app_url` - Application URL (HTTP)
- `app_port` - Application server port
- `node_version` - Installed Node.js version

## Architecture: Single Server (Staging)

**Full-Stack on One Server:**
- PostgreSQL database (port 5432)
- Node.js backend application (port 3000)
- Frontend application (served by backend or separate process)
- All on one droplet: Start with $6/month, upgrade to $12-24/month if needed

**Benefits:**
- Cost-effective for staging (start small)
- Simple deployment
- Easy to manage
- Can upgrade droplet size if performance issues occur
- Can scale to separate servers later if needed

**Strategy:** Start with smallest droplet (`s-1vcpu-1gb` at $6/month) and upgrade if you experience:
- Out-of-memory errors
- Slow performance
- Database connection issues
- Application crashes

**To upgrade:** Change `droplet_size` in `terraform.tfvars` and run `terraform apply`.

**Self-Managed vs Managed:**
- **Self-managed:** VPS + install everything ($6/month start, upgrade to $12-24/month if needed, full control)
- **Managed:** Provider services ($50-100+/month, less control)

**Use self-managed for cost savings.**

## Security
- [ ] Credentials in secrets (not state)
- [ ] Firewall restricts IPs
- [ ] SSL/TLS enabled
- [ ] Backups configured
- [ ] State file secured

## Troubleshooting
- **Provider not found:** `terraform init`
- **Auth failed:** Check credentials/permissions
- **Connection fails:** Check firewall, wait for init
- **State locked:** `terraform force-unlock <ID>`
- **High cost:** Use smaller instance, self-managed

## What Gets Installed Automatically

The server initialization script (`user_data.sh`) automatically installs:
- PostgreSQL 16 (database server)
- Node.js 22 (runtime for backend/frontend)
- Yarn (package manager)
- PM2 (process manager)
- UFW Firewall (configured for HTTP, HTTPS, SSH, PostgreSQL, app port)

## Checklist
- [ ] Choose provider
- [ ] Create Terraform files
- [ ] Reference `src/shared/single-source.ts` (when created)
- [ ] Test: init, validate, plan, apply
- [ ] Verify database accessible
- [ ] Verify Node.js installed (`ssh root@<server_ip> node --version`)
- [ ] Deploy application code to `/opt/cody2025`
- [ ] Set up secrets management

**Next:** Create `init.sql` schema definition, then deploy application code.

---

## Related Documentation

- [6.1_DIGITALOCEAN_SETUP.md](./6.1_DIGITALOCEAN_SETUP.md) - DigitalOcean account and API token setup
- [1.0_PRINCIPLES.md](./1.0_PRINCIPLES.md) - Single source of truth principles
- [5.0_PLAN.md](./5.0_PLAN.md) - Overall project plan
- [7.0_SECRETS_MANAGEMENT.md](./7.0_SECRETS_MANAGEMENT.md) - Secrets configuration
- [8.0_SECURITY.md](./8.0_SECURITY.md) - Security practices
