# Step 1: Terraform PostgreSQL Setup

## Prerequisites
- Terraform ≥ 1.7
- Cloud provider account and credentials

## Cloud Providers (Cost-Effective)
- **Hetzner** - $4-6/month (best price, EU-based, good for worldwide)
- **Vultr** - $6-10/month (multiple regions including EU)
- **DigitalOcean** - $6-12/month (easiest, multiple regions)
- **Linode** - $12-24/month (multiple regions)

**Recommendation:** 
- **Hetzner** for cost (EU-based, good latency for EU/ME customers)
- **DigitalOcean** for ease of use and multiple regions
- Consider region selection based on customer base (EU regions for Israeli company serving worldwide)

## Structure
```
infra/terraform/
├── main.tf
├── variables.tf
├── outputs.tf
├── versions.tf
└── terraform.tfvars.example
```

## Configuration
All values should be defined in `src/shared/single-source.ts` when created (see [1.0_PRINCIPLES.md](./1.0_PRINCIPLES.md)). Example structure:
```typescript
export const CONFIG = {
  DATABASE: {
    VERSION: '16',
    SIZE: 's-1vcpu-1gb',
    REGION: 'fra1', // Example: Frankfurt (EU) - adjust based on customer base
    // Alternative regions: 'ams3' (Amsterdam), 'lon1' (London), 'nyc3' (New York)
    STORAGE_SIZE_GB: 25,
    BACKUP_ENABLED: true,
  },
} as const;
```

**Region Selection for Israeli Company:**
- **EU regions** (Frankfurt, Amsterdam, London) - Good for EU customers and Israeli company
- **US regions** - For US customer base
- Consider multi-region setup for worldwide customers if needed

## Files

**versions.tf** - Terraform/provider versions  
**variables.tf** - Input variables (reference `src/shared/single-source.ts` when created)  
**main.tf** - Provider + database resource + security  
**outputs.tf** - Connection details (mark sensitive)

## Steps
1. `terraform init`
2. Create files (reference `src/shared/single-source.ts` when created)
3. `terraform validate`
4. `terraform plan`
5. `terraform apply`

## Outputs
- `database_host`, `database_port`, `database_name`
- `database_user`, `database_password` (sensitive)
- `database_url` (sensitive)

## Self-Managed vs Managed
- **Self-managed:** VPS + install PostgreSQL ($4-12/month, full control)
- **Managed:** Provider service ($15-50/month, less control)

**Use self-managed for cost savings.**

## Security
- [ ] Credentials in secrets (not state)
- [ ] Firewall restricts IPs
- [ ] SSL/TLS enabled
- [ ] Backups configured
- [ ] State file secured

## Troubleshooting
- **Provider not found:** `terraform init`
- **Auth failed:** Check credentials/permissions
- **Connection fails:** Check firewall, wait for init
- **State locked:** `terraform force-unlock <ID>`
- **High cost:** Use smaller instance, self-managed

## Checklist
- [ ] Choose provider
- [ ] Create Terraform files
- [ ] Reference `src/shared/single-source.ts` (when created)
- [ ] Test: init, validate, plan, apply
- [ ] Verify database accessible
- [ ] Set up secrets management

**Next:** Create `init.sql` schema definition.

---

## Related Documentation

- [1.0_PRINCIPLES.md](./1.0_PRINCIPLES.md) - Single source of truth principles
- [5.0_PLAN.md](./5.0_PLAN.md) - Overall project plan
- [7.0_SECRETS_MANAGEMENT.md](./7.0_SECRETS_MANAGEMENT.md) - Secrets configuration
- [8.0_SECURITY.md](./8.0_SECURITY.md) - Security practices
